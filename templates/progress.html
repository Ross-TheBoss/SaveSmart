<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaveSmart - Savings Progress</title>
    <link rel="stylesheet" href="styles.css"> </head>

<body>
    <header>
        <nav class="navbar">
            <a href="index.html" class="logo">SaveSmart</a>
            <ul class="nav-links">
                <li><a href="cart.html">Cart</a></li>
                <li><a href="#">Progress</a></li>
                <li><a href="#">Log Out</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <h1>Savings Progress</h1>

    <!-- Global Stacked Progress Bar -->
    <div class="global-progress-title">Total Savings Progress</div>

    <div class="progress-and-goal-container">
        <div id="global-progress-container" class="progress-container"></div>
        <div id="global-progress-goal" class="progress-goal">Holiday Fund</div>
    </div>

    <form action="{{ url_for('set_savings_goal') }}" method="POST">
        <label for="target_amount">New Savings Goal:</label> <!-- Set how much you are saving. --> 
        <input type="number" id="target_amount" name="target_amount" min="0.01" step="0.01" required>
        
        <button type="submit">Reset Savings</button>
    </form>
    

    <button>Update Savings Goal</button> <!-- Set what you are saving for -->
    
    <h2>Individual Contributions</h2>
    <div id="users-container"></div>

    <script>
        // Generate a consistent color for each user
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 70%, 50%)`; // Unique color based on username
            return color;
        }

        // Fetch savings data from the Flask backend
        async function fetchSavingsData() {
            try {
                const response = await fetch('/savings');
                const savingsData = await response.json();
                displaySavingsProgress(savingsData);
            } catch (error) {
                console.error('Error fetching savings data:', error);
            }
        }

        // Display savings progress for individual users and overall progress
        function displaySavingsProgress(savingsData) {
            const usersContainer = document.getElementById('users-container');
            const globalProgressContainer = document.getElementById('global-progress-container');
            
            usersContainer.innerHTML = '';  // Clear previous content
            globalProgressContainer.innerHTML = '';

            let totalGoal = savingsData["goal"]["target_amount"]
            let totalSaved = savingsData["users"].reduce((sum, user) => sum + user.saved_amount, 0);

            // Global stacked progress bar (total savings)
            if (totalSaved > 0) {
                savingsData["users"].forEach(user => {
                    if (user.saved_amount > 0) {
                        const progressSegment = document.createElement('div');
                        progressSegment.classList.add('progress-bar');
                        progressSegment.style.width = `${(user.saved_amount / totalGoal) * 100}%`;
                        progressSegment.style.backgroundColor = getUserColor(user.username);
                        progressSegment.textContent = `£${user.saved_amount}`;
                        globalProgressContainer.appendChild(progressSegment);
                    }
                });
            } else {
                globalProgressContainer.textContent = "No savings yet.";
            }

            document.getElementById("global-progress-goal").textContent = savingsData["goal"]["name"];

            // Individual user progress bars
            savingsData["users"].forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.classList.add('user-progress');

                const usernameDiv = document.createElement('div');
                usernameDiv.classList.add('username');
                usernameDiv.textContent = `${user.username} - Goal: £${totalGoal}, Saved: £${user.saved_amount}`;

                const progressAndGoalContainer = document.createElement('div');
                progressAndGoalContainer.classList.add('progress-and-goal-container');

                const progressContainer = document.createElement('div');
                progressContainer.classList.add('progress-container');

                const goalText = document.createElement('div');
                goalText.textContent = savingsData["goal"]["name"];
                goalText.classList.add("progress-goal");

                if (user.saved_amount > 0) {
                    console.table(user.contributions);
                    user.contributions.forEach(contrib => {
                        const progressBar = document.createElement('div');
                        progressBar.classList.add('progress-bar');
                        progressBar.style.width = `${(contrib.amount / totalGoal) * 100}%`;
                        progressBar.style.backgroundColor = getUserColor(contrib.username);
                        progressBar.textContent = `£${contrib.amount}`;
                        progressContainer.appendChild(progressBar);
                    });
                } else {
                    progressContainer.textContent = "No savings yet.";
                }

                progressAndGoalContainer.appendChild(progressContainer);
                progressAndGoalContainer.appendChild(goalText);


                userDiv.appendChild(usernameDiv);
                userDiv.appendChild(progressAndGoalContainer);
                usersContainer.appendChild(userDiv);
            });
        }

        // Fetch savings data when the page loads
        fetchSavingsData();
    </script>

    <footer>
        <p>&copy; 2025 SaveSmart. All Rights Reserved.</p>
        <ul class="footer-links">
            <li><a href="faqs.html">FAQs</a></li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
    </footer>
</body>

</html>