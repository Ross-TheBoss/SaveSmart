<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Savings Progress</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #aaa;
        }
        .progress-container {
            width: 100%;
            background-color: #f3f3f3;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            height: 30px;
            margin-bottom: 20px;
        }
        .progress-bar {
            height: 30px;
            text-align: center;
            color: white;
            line-height: 30px;
            transition: width 0.5s;
        }
        .username {
            font-weight: bold;
        }
        .global-progress-title {
            margin-top: 40px;
            font-size: 1.2em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Savings Progress</h1>

    <!-- Global Stacked Progress Bar -->
    <div class="global-progress-title">Total Savings Progress</div>
    <div id="global-progress-container" class="progress-container"></div>

    <button>Set New Goal</button> <!-- Set what you are saving for -->
    <button>Reset Savings</button> <!-- Set how much you are saving. -->
    
    <h2>Individual Contributions</h2>
    <div id="users-container"></div>

    <script>
        // Generate a consistent color for each user
        function getUserColor(username) {
            let hash = 0;
            for (let i = 0; i < username.length; i++) {
                hash = username.charCodeAt(i) + ((hash << 5) - hash);
            }
            const color = `hsl(${hash % 360}, 70%, 50%)`; // Unique color based on username
            return color;
        }

        // Fetch savings data from the Flask backend
        async function fetchSavingsData() {
            try {
                const response = await fetch('/savings');
                const savingsData = await response.json();
                displaySavingsProgress(savingsData);
            } catch (error) {
                console.error('Error fetching savings data:', error);
            }
        }

        // Display savings progress for individual users and overall progress
        function displaySavingsProgress(savingsData) {
            const usersContainer = document.getElementById('users-container');
            const globalProgressContainer = document.getElementById('global-progress-container');
            
            usersContainer.innerHTML = '';  // Clear previous content
            globalProgressContainer.innerHTML = '';

            let totalGoal = savingsData.reduce((sum, user) => sum + user.goal_amount, 0);
            let totalSaved = savingsData.reduce((sum, user) => sum + user.saved_amount, 0);

            // Global stacked progress bar (total savings)
            if (totalSaved > 0) {
                savingsData.forEach(user => {
                    if (user.saved_amount > 0) {
                        const progressSegment = document.createElement('div');
                        progressSegment.classList.add('progress-bar');
                        progressSegment.style.width = `${(user.saved_amount / totalGoal) * 100}%`;
                        progressSegment.style.backgroundColor = getUserColor(user.username);
                        progressSegment.textContent = `$${user.saved_amount}`;
                        globalProgressContainer.appendChild(progressSegment);
                    }
                });
            } else {
                globalProgressContainer.textContent = "No savings yet.";
            }

            // Individual user progress bars
            savingsData.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.classList.add('user-progress');

                const usernameDiv = document.createElement('div');
                usernameDiv.classList.add('username');
                usernameDiv.textContent = `${user.username} - Goal: $${user.goal_amount}, Saved: $${user.saved_amount}`;

                const progressContainer = document.createElement('div');
                progressContainer.classList.add('progress-container');

                if (user.saved_amount > 0) {
                    user.contributions.forEach(contrib => {
                        const progressBar = document.createElement('div');
                        progressBar.classList.add('progress-bar');
                        progressBar.style.width = `${(contrib.amount / user.goal_amount) * 100}%`;
                        progressBar.style.backgroundColor = getUserColor(contrib.username);
                        progressBar.textContent = `$${contrib.amount}`;
                        progressContainer.appendChild(progressBar);
                    });
                } else {
                    progressContainer.textContent = "No savings yet.";
                }

                userDiv.appendChild(usernameDiv);
                userDiv.appendChild(progressContainer);
                usersContainer.appendChild(userDiv);
            });
        }

        // Fetch savings data when the page loads
        fetchSavingsData();
    </script>
</body>
</html>